---
layout: post
title: "Как дебажить подключения юзеров на Ideco AS 3 и Carbon AS 5"
date: '2013-02-14 07:12:00'
tags:
- carbon_a_s_5
- nastroika
- otladka
---

Этот мануал в принципе справедлив и для Ideco AS 3, разве что не нужно делать chroot.

# Вступление
Если пользователи не могут получить доступ к сети перед обращением в суппорт где вам помогут, можно сэкономить время отвлекаемых разработчиков выполнив следующие шаги.Ведь каждый час моего свободного времени даёт новую плюшку в продукт :)Вообще все связанное с Carbon AS стоит изучать выполнив смену корня, все команды ниже написаны с учётом того, что вы уже сделали это:chroot /app/carbon_as
<a name="more"></a>

## [](http://www.blogger.com/blogger.g?blogID=8294895154382355301)1\. Узнать информацию о авторизованных пользователях
cat /var/lib/nas_users.datВ этом файле записаны строки в виде:ip | snat | negbal | macКак минимум IP пользователя должен быть записан в этом файле, если нет - переходим на следующий шаг.

## [](http://www.blogger.com/blogger.g?blogID=8294895154382355301)2\. Проверить команды от биллинга
tail -100 /var/log/ideco_nasd.logесли вы используете Ideco ACP 3 в качестве биллинга, либоtail -100 /var/log/carbon_nasd.logЕсли вы используете Carbon Billing 5.В этих файлах записываются все передаваемые на маршрутизатор команды, а также ошибки в случае если что-то идёт не так.Если команд нет, то переходим на следующий шаг.Если команды есть, то проверьте, что данные которые приходят соответствуют действительности. Скорее всего проблема в настройках тарифа или данных пользователя.

## [](http://www.blogger.com/blogger.g?blogID=8294895154382355301)3\. Проверить настройки управления
Проверьте данные в локальном меню связанные с настройкой маршрутизатора.Проверьте, правильно ли указан IP адрес биллинга, совпадает ли Radius Secret.Проверьте, что не напутали с портами аккаунтинга и авторизации.Если на вид всё верно, то переходим на следующий шаг.

## [](http://www.blogger.com/blogger.g?blogID=8294895154382355301)4\. Если команды были - проверьте наличие правил
Для примера IP пользователя: 10.0.201.100Проверьте, что пользователю разрешён доступ к сети iptables -nvL | grep -w 10.0.201.100Проверьте что есть SNAT, если он используется, либо, что его нет, если используются белые IPiptables -t nat -nvL | grep 10.0.201.100Проверьте маркировку пакетов пользователя для шейпераiptables -t mangle -nvL | grep 10.0.201.100Если один из этих пунктов даёт не те результаты, которые ожидаются, то нужно сперва проверить параметры пользователя в биллинге, если с ними всё в порядке, то связаться с технической поддержкой.

## [](http://www.blogger.com/blogger.g?blogID=8294895154382355301)5\. Проверка доступа до биллинга
Самое банальное что можно сделать (но в 80% случаев этого и достаточно): проверить доступ до биллинга ping'ом.Для примера IP адрес биллинга будет равен 10.0.0.10ping -c 4 10.0.0.10Если ответы есть, то это ещё не гарантия, что доступ полноценный.Проверьте следующее:arping -c 1 -I Eeth0 10.0.0.10После -I должно идти имя внешнего интерфейса.

## [](http://www.blogger.com/blogger.g?blogID=8294895154382355301)6\. Проверьте что трафик вообще идёт
tcpdump -nvi any host 10.0.0.10Должны идти пакеты на 44, 1812, 1813  порты.Для того чтобы заставить их идти - попробуйте переподключить какого-нибудь пользователя с IP авторизацией.

# [](http://www.blogger.com/blogger.g?blogID=8294895154382355301)Я всё ещё не нашёл ничего криминального
В принципе сейчас можно без зазрений совести обратиться в суппорт, у вас происходит что-то странное.Но если хотите, можете следовать инструкциям дальше.

## [](http://www.blogger.com/blogger.g?blogID=8294895154382355301)Для PPTP-пользователей
Вы можете посмотреть что происходит с плагином авторизации по Radius: strace -s 500 -f -p `pidof pptpd`Для того чтобы читать вывод трасировщика - придётся немного потренироваться.В первую очередь стоит обратить внимание на коннекты до биллинга - если они возвращают 0 (Timeout), то это проблема с сетью, либо Radius-сервер не слушает на указанном в настройках порту.Проверьте это командойps aux | grep radiusна биллинге. Если Radius не запущен, то само собой его надо запустить, предварительно узнав причину по которой он не запущен.

## [](http://www.blogger.com/blogger.g?blogID=8294895154382355301)Для пользователей с IP авторизацией
На биллинге и на самом Carbon AS запуститеtcpdump -nvi any udp port 44Отключите абонента в биллинге.Должен уйти 1 или более пакетов с биллинга и точно такое же до AS.Если пакеты не уходят - нужно опять же проверить запущен ли демон eventdps aux | grep event