---
layout: post
title: "Автотесты для модулей ядра и их юзерспэйса"
date: '2013-05-09 03:08:00'
tags:
- linux_kernel
- moduli_iadra
- autotests
- continuous_integration
- avtotiesty
---

Как я тестирую Carbon Reductor для CentOS 6.4

## Подготовка

### Стенд с Reductor
Создаём виртуальную машину, устанавливаем на неё CentOS 6.4 x86_64, настраиваем сеть, (виртуальная машина должна служить шлюзом для другой тестовой виртуалки), SSH, закидываем их всех нужных мест (см ниже) публичные ключи для авторизации без паролей итд. Выключаем, копируем образ её диска, называем его как-нибудь в духе centos_6.4_minimal.img.tmplt.

### Стенд с абонентом
Создаем ещё одну виртуальную машину, настраиваем на ней сеть так, словно стенд с Reductor является для неё шлюзом. На всякий случай вешаем на неё IP для подключения по SSH.

### Подробнее о сети
Виртуальные сетевки eth0 в реальном br0 через который есть доступ к сети, а eth1 в br1, ограниченная локальная сеть.Для Reductoreth0 10.90.140.160/16 10.90.1.1eth1 192.168.15.1/24Для абонентаeth0 10.90.140.161/16eth1 192.168.15.2/24 192.168.15.1

## Примерный сценарий теста
Создаём простенький скрипт, который будетпришибать стенд с reductor по ночамкопировать шаблон диска поверх текущего образастартовать виртуалкупри появлении пингов - по SSH запускать сборкуесли сборка не завершилась удачно на любом из этапов - послать письмо об этомесли сборка завершилась удачно - слить собранный RPM пакет по SCP на тестовую виртуалкузапустить установку зависимостей и RPM-пакетапроверить код возврата и доступность стенда с reductor (мало ли, Kernel Panic), если недоступна - письмо и падаем.зайти на стенд с reductor, стартануть окружение модуля (/etc/init.d/reductor restart), повторить шаг №8зайти на стенд с абонентом и попробовать обратиться на 5 запрещённых сайтов (wget'ом), проверить, что они не открываются, если открылись - письмо и падаем.зайти на стенд с абонентом и попробовать обратиться на 5 разрешённых сайтов (wget'ом), проверить, что они открываются, если не открылись - письмо и падаем.повторяем пункт №8.При этом все результаты тестов скидываем в какой-нибудь файлик в духе Build kernel module: okBuild iptables: okBuild tar.gz: okBuild rpm: okInstall RPM: okStart Reductor: okForbidden sites closed: 5/5Normal sites opened: 5/5Still work: okИ отсылаем с помощью msmtp.

## В планах
Позже по идее надо бы доделать ещё пару тестов:Добавление неправильной arp записи на адрес шлюза на абоненте и ловлю такого трафика в iptables редуктора (по умолчанию не ловится).Поверх добавить Vlan'ы (обычно зеркало с коммутаторов заvlanено).Что получаем в результатеУбрав отправку писем и настройку абонента мы получаем.. скрипт для установки Carbon Reductor на CentOS вообще без настроек юзером.