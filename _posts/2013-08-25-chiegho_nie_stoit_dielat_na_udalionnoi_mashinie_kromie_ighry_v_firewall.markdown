---
layout: post
title: "Чего не стоит делать на удалённой машине кроме игры в firewall"
date: '2013-08-25 07:13:00'
tags:
- linux
- ssh
- neighbour_table_overflow
- ip_neigh
---

Все знают, что играться с файрволом на удалённой машине - к дороге :)
Но ещё хуже - играться с таблицей маршрутизации.
Значительно хуже - сотни раз наступая на грабли, наступить в 101й.

Итак, сегодня я отжог и выполнил на удалённой машине

while sudo ip neigh flush dev br0; do
          :
done

А ведь всё началось с того, что я искал какие виртуалки включены в сетке нашей тестировщицы и получил в dmesg.

Neighbour table overflow

Не зная, как работает ip neigh flush, экспериментальным путём выяснил, что после пары выполнений он вычищает около 100 маршрутов из памяти. И видите ли стало мне лень руками выполнить его раз 10-15.

Собственно мораль - **не играйте с таблицей маршрутизации в бесконечном цикле без sleep 1.&nbsp;**Привело к потере управления машиной, перестала пинговаться извне и отлетел ssh.

Вышел из ситуации всё ещё не до конца понимаю как - виртуалка запущенная на хост-машине оказалась куда более доступной и отзывчивой. Более того, с неё хост-система пинговалась и даже удалось подключиться по SSH (с откликом на нажатие клавиши в ~15 секунд). С помощью команды
w
Заметил, что pts на котором я запустил этот while всё ещё на месте, несмотря на закрытие терминала и ssh-сессии вместе с ним. Дальше оставалось лишь сделать
pkill -9 -t pts/1
и мысленно извиниться перед ядром бедной рабочей машинки за то, что над ним так издевались.