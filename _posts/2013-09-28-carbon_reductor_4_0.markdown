---
layout: post
title: Carbon Reductor 4.0
date: '2013-09-28 03:36:00'
tags:
- novaia_viersiia
- carbon_reductor_4
- d_p_i
- u_r_l_fil_tratsiia
- fil_tr_dlia_provaidierov
---

Буквально на этой неделе зарелизил Carbon Reductor четвёртой версии с кучей новых плюшек:

### Редирект на страницу-заглушку.
Да, теперь у нас есть модуль iptables, осуществляющий tcp-session-hijacking "атаку" и отсылающий пользователю http 302-found вместо tcp-reset. Намучился с ним здорово, разработка основной части заняла около двух недель чистого времени.По умолчанию ведёт на http://helpdesk.carbonsoft.ru/deny, но можно и свой URL указать. Работать будет 20 дней, то есть до 10 октября, так как это демо-версия для всех, дальше доступна будет только 10 дней демо-версии и после покупки поддержки SLA2/SLA3.

### Диагностика с отчётами на почту
Поскольку следить за всеми серверами вручную слишком накладно (у техподдержки обращений и так хватает, а мне ещё и развитием продукта заниматься надо) теперь есть удобная штука. Раз в час запускается проверка типичных багов в настройке итд, если хоть одна проверка провалилась - на почту администратору и нашей поддержке уходит письмо с результатами диагностики, выводом сетевых настроек итд. В результате все проблемы не скрываются в долгий ящик, а решаются сразу при проявлении.

### Больше информации уходит на наш сервер
Теперь сервер активации логирует ещё и то, какая версия Carbon Reductor установлена у пользователя, теперь можно легко получить список тех, кому надо обновиться. Единственный минус, пока нет различий между версией для Carbon AS/Carbon Billing и для CentOS, но поправить - пара минут.

### Исправлен "плавающий" код установки
Раньше код установки брался из серийного номера процессора, когда этот код писался - как-то не задумывались о том, что он будет выполняться на многопроцессорных (не многоядерных, а именно многопроцессорных) серверах и код будет браться в зависимости от того, на каком процессоре он выполняется. Переписать-то переписали, а вот при обновлении вышло много гадости, из-за опечатки не менялся URL сервера обновлений, в итоге пользователям приходил неподходящий код активации. Но, тьфу-тьфу, сейчас вроде у всех всё в порядке, да в новой версии URL автоматически патчится. :)

### 100% автоматическое обновление
Был такой косяк, когда из-за того, что при вызове из cron не была определена переменная $LANG падал iconv при генерации XML-запроса, на чём обновление и обламывалось. Во все скрипты, вызываемые из cron теперь добавлены export LANG, что отлично решило проблему.Ещё был момент - поскольку PHP для работы с сервисом РосКомНадзора живёт внутри chroot, ему необходим был /etc/resolv.conf чтобы резолвить домены. Собственно, поскольку сделать всё надо было вчера, да и мало ли - пользователь не настроит DNS, внутри chroot был константно прошит nameserver 8.8.8.8\. Что отлично обламывало скрипт, в случае если весь DNS трафик редиректится на DNS-сервер провайдера и ответ приходит не от 8.8.8.8\. Решилось достаточно просто:if grep -q nameserver /etc/resolv.conf; then   cp /etc/resolv.conf /usr/local/Reductor/reductor_container/etc/resolv.conffiНу и кое кто из провайдеров говорил, что теперь РосКомНадзор желает чтобы его списки качали аж 4 раза в день. Чтож, надо так надо, в редукторе теперь это из коробки.

### Исключены "подвешивания" сервера userspace'ом Reductor
Был за мной такой косяк, в стартовом скрипте я не форкал новую задачу, а просто запускал основной стартовый скрипт, который мог и повиснуть.

### Добавлен список МинЮста
Дадада, мы смогли распарсить этот адовый трэш с невалидными записями, синими болванками с аудиофайлом 123.mp3 и нечитаемыми даже человеком URL и кучей страниц вконтакте с качеством 95% (остальное добили руками и пока список статичный). Как только закончу с парой задач по другим продуктам, добью этот парсер и он будет работать внутри Carbon Reductor.

### Что нам стоит OS настроить
Решена проблема с Neighbour table overflow, теперь при рестарте Reductor ядро CentOS проходит тюнинг для работы с большим количеством запросов.

### Логирование, логирование повсюду
Теперь ещё больше информации логируется и узнать что и как сломалось 15 часов назад стало чуточку проще. В /var/log/reductor/ теперь около 15 лог-файлов для основных bash-скриптов.