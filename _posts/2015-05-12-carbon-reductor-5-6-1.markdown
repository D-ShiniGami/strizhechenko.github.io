---
layout: post
title: Carbon Reductor 5.6.1
date: '2015-05-12 12:50:58'
---

# Ускорения

Основная тематика этого релиза - ускорение всего чего можно и в результате сокращение простоев фильтрации.

## Обновление

Обновление ускорено в основном за счёт ускорения yum. При установке нового пакета он вызывается с выключенным плагином fastestmirror и использует только уже имеющуюся в системе информацию о пакетах, поскольку установка происходит с уже скачанного файла.

## Перезапуск

Практически все долгие вещи вынесены из рестарта в обновление списков, а некоторые дополнительно ускорены:

- обновление списка минюста
- обновление единого реестра
- разбор единого реестра
- подгрузка недостающих сигнатур
- резолв ip адресов https ресурсов, при включенной опции

Стартовые скрипты были отпрофилированы, несколько мест, которые отнимали больше всего времени были отрефакторены, в первую очередь это:

- загрузка IP адресов в ipset
- загрузка URL в ядро

## Итоги

В целом простои удалось практически исключить:

### До оптимизации

- Обновление на новую версию - 1м 20с
- Перезапуск сервиса - 35с
- Загрузка списков запрещённых сайтов - 8с

### После оптимизации

- Обновление на новую версию - 25-30с
- Перезапуск сервиса - 3с
- Загрузка списков запрещённых сайтов - 1с

Тем не менее на 5.6.3 версию мы оставили ещё 3 места, которые можно ускорить или изменить, ожидаем получить следующие результаты, которые довольно неплохи:

- Обновление на новую версию - 10с
- Перезапуск сервиса - 0.4с
- Загрузка списков запрещённых сайтов - 0.01с

Пугаться довольно большого промежутка в обновлении на новую версию не стоит - это происходит не так уж часто, около 2 раз в неделю, в 7 утра по времени, указанному на сервере Carbon Reductor.

# Прочее изменения

## Мастер тонкой настройки сетевых карт

Пока что очень сырой, временами пишет не совсем по-русски (в сервере 2 ядер), но помочь понять что можно сделать с сетевыми картами на этом сервере, чтобы справляться с нагрузкой, создаваемой зеркалом трафика, а что нельзя с позволяет, пусть и с качеством в 70%.

### Пример вывода:

    [root@carbon ~]# /usr/local/Reductor/bin/nic_tuning_help 

    # Общая информация
    
    - Сканированием трафика занимается 1 сетевая карта.
    - Имеется 12 ядер на процессоре.
    
    # eth0
    
    ## Размеры буфера
    
    RX-буфер уже установлен на максимальное возможное значение, ничего делать не нужно.

	## Распределение прерываний
    
    У eth0 4 очереди:

    - eth0-q0
    - eth0-q1
    - eth0-q2
    - eth0-q3

    Они обрабатываются одним ядром, можно добиться улучшения работы переносом прерываний каждой очереди на отдельное ядро.

    ## Прочее
    
    Обнаружена специфическая проблема сетевых карт broadcom!
    Рекомендуется воспользоваться статьёй http://support.hp.com/us-en/document/c03854197. Если перевести её в формат руководства к действию на русском языке, то надо сделать следующее

    1. Создать файл /etc/modprobe.d/be2net.conf в который записать строчку:
    options be2net rx_frag_size=4096
    2. Перезагрузить сервер командой reboot
    
    ## Процессор
    
    Текущая частота процессора может быть увеличена с 1800MHz до 3600MHz.
    
    Для этого нужно добавить в rc.local следующие строки:
    
    # maximize cpu freq
    cpucount=$(grep -c 'model name' /proc/cpuinfo)
	sysdir=/sys/devices/system/cpu
	for cpu in $(eval echo cpu{0..$((cpucount-1))}); do
    	cat $sysdir/$cpu/cpufreq/scaling_max_freq > $sysdir/$cpu/cpufreq/scaling_min_freq
	done

## Минорные исправления диагностики

Не работало исправление ошибки с неправильным suds, установленным из репозиториев CentOS, что ранее могло привести к отсутствию выгрузок единого реестра.

## Добавлен мастер настройки

После установки Carbon Reductor будет вызван мастер настройки, который запросит большую часть нужной для первого старта информации:

- информацию о компании
- список IP адресов администраторов
- ваши предпочтения в алгоритме фильтрации
- предложит настроить сканирование трафика

## Прочее

Также после всех доработок из-за небольшого изменения переставали работать отчёты по выгрузкам в веб-интерфейсе, новая версия веб-интерфейса уже доступна для обновления, но обновление нужно запустить вручную.

Также был немного упрощёна часть кода, занимающаяся активацией сервера, как в ядре, так и в пользовательском пространстве, что позволит в версии 5.6.3 сократить количество обращений к нашему серверу (которые, как оказалось, в зависимости от качества предоставленного Carbon Reductor каналу для доступа в интернет могут тянуться довольно долго, обычно такое характерно для провайдеров Дальнего Востока, а также использующих спутниковый интернет)