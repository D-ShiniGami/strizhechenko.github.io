---
layout: post
title: Carbon Reductor 7.2.2
date: '2016-08-08 07:39:45'
---

# Выгрузки реестра и его обработка

В этом месяце Роскомнадзор опять подкинул работы новыми рекомендациями по работе с единым реестром.

- Теперь отчёт о возникновении проблемы с выгрузкой реестра содержит в себе подробности этой проблемы.
- Добавлен скрипт для превращения списка бэкапов в git-репозиторий с файлом dump.xml для отслеживания изменений в нём. К сожалению, безумно тормозит из-за размеров реестра, но не выкидывать же.
- Добавили отказоустойчивости для выгрузок реестра
- Запуск (в основном ручной) нового процесса выгрузки реестра ожидает освобождение lock-файла, вместо убийства предыдущего процесса выгрузки. Ранее оно приводило к проблеме с "Загрузкой URL в ядро", в случае если обновление списков "убивалось" в процессе разбора реестра в отдельные файлы.
- Добавлена поддержка масок доменов в разборе реестра.
- В некоторых случаях проброс переменной LC\_CTYPE отличного от ru_RU.UTF-8 при подключении к Carbon Reductor по SSH и запуск обработки списка приводил к ошибке при обработке списков.
- В случае запуска выгрузок на неактивированном Carbon Reductor запускалась старая версия системы активации, что не завершалось удачно. Удалена и заменена актуальной.
- Повышена отказоустойчивость загрузки URL в ядро, при неудаче теперь спустя несколько секунд запускается обработка списков и выполняется повторная попытка загрузки.
- Добавлен демон rknd, инициирующий экстренные выгрузки реестра. Помог обнаружить и исправить три недостатка в процессах выгрузки реестра и загрузки URL/доменов в ядро. Из уже исправленного:
  - рестарт при обновлении
  - проверка раз в пять минут, а не в одну минуту
  - правильный учёт временных зон
  - запуск выгрузки с таймаутом в 50 минут

# Модули ядра

## DNS

- В dnsmatch добавлена поддержка выбора режима матчинга: exact (--exact) и with-subdomains (по умолчанию). Пока не используется, в devel-ветке есть код, который добавляет такую поддержку в кастомные списки DNS (и сами кастомные списки DNS).
- В dnsmatch добавлена поддержка регистронезависимого (--icase) поиска, отключенная по умолчанию. Он значительно менее производительный, лучше его добавлять дополнительным правилом для тех подсетей откуда запросы часто идут не в lower-case.
- значительно снижена вероятность коллизии хэшей в dnsmatch, что позитивно сказывается на производительности.
- Удалено всё оставшееся отладочное логирование, а также логирование checked / matched в dnsmatch (в основном так как сильно засоряло код).

## HTTP

- подготовлена сборка матчера HTTP в userspace, поддерживающая как HTTP так и HTTPS ссылки в качестве redirect program для squid (готово на 95%).
- Добавлена поддержка очень коротких доменов в HTTP-матчере (например [http://x.yz](http://x.yz))

# Мелочи

- Более человекчитаемые commit'ы в /etc/sysconfig/network-scripts/ создаваемые мастером настройки сети.
- Добавили утилиту для сохранения трафика от проверок ревизора для последующего анализа - revisor_dump.sh
- Теперь принятие решения об обновлении на новую версию целиком лежит на сервере обновления, все "умности" на клиентской стороне удалены.
- Периодические задачи, потенциально способные повлиять на работоспособность фильтрации, подстроены под график проверок ревизора. Добавление в крон только вручную. Сохраняет дампы трафика в аккуратно подобранной структуре каталогов в /var/lib/revisor_dump/.
- При запуске рестарта по SSH, IP адрес запустившего логируется.
- Не создавались ссылки на цепочку mirror_traffic в таблице raw, если не была включена опция NOTRACK. В результате не работала его особая обработка и отсеивание лишнего на раннем этапе.
- Проверка обработки пакетов в диагностике иногда имела ложные срабатывания.
