---
layout: post
title: "Сравнение bind и unbound в целях фильтрации трафика по DNS"
date: '2016-11-03 15:48:00'
---

# О чём вообще статья.

Есть такой репозиторий: https://github.com/carbonsoft/named_fakezone_generator

Его основная задача - блокировать часть запрещённых сайтов по доменному имени на стороне DNS-сервера провайдера. Оставим моральный аспект этого репозитория за рамками этой статьи, нас интересуют только цифры.

Учитывая то, что реестр запрещённой информации в РФ судя по всему будет только расти, необходимо знать, сколько ресурсов нужно для того, чтобы обеспечивать фильтрацию, достаточную, для того чтобы:

1. Не потерять лицензию / закрыться из-за штрафов.
2. Не потерять абонентов из-за ухудшения качества сервиса.

Общие данные: для каждого добавленного для фильтрации домена необходимо отвечать одним IPv4 адресом.

# Поддержка доменов с подчёркиванием

bind9 от таких доменов, оказавшихся в конфиге валится и не стартует, ругаясь. Одно из решений - заменять на дефис.

unbound чувствует себя прекрасно, на запросы об этих доменах отвечает.

# Потребление памяти

Формат записи: 1 число - VSZ, 2 - RSS из вывода ps aux. Наблюдения проводились за сервером, находящимся в состоянии "покоя" - к нему обращалась несколько раз тестовая машина только для того, чтобы проверить, что он вообще работает и живой.

| Число доменов | Unbound            | Bind9 |
|:-------------:|:------------------:|:-----:|
| 8500          | 210240 49316 | 357352 101172 |
| 25000         | 346528 157180 | 970376 306788 |
| 50000         | 556584 315508 | 1299592 646672 |
| 100000        | 979256 823304 | out-of-memory error |
| 200000        | 1824456 1284380 | out-of-memory error |
| 400000        | 3515116 2655296 | out-of-memory error |

# Что стоило ещё померять

- Деградация в скорости ответов
- Замедление рестарта

# Выводы

После 50000 доменов наступает существенная деградация в скорости рестарта у bind9. На 100000 без дополнительного тюнинга bind в openvz начал валиться с out of memory error прямо при старте, съев около 1гб памяти (несмотря на то, что контейнеру было доступно 4гб).

Для одного пользователя, решившего опросить все добавленные домены с localhost потребление памяти unbound'ом не менялось.

# Размышления

Вообще идея использовать для фильтрации DNS-сервера может показаться довольно странной. Однако DNSSec никаким спуфингом сбоку не побороть, разве что установкой фильтрации в разрыв (что на мой взгляд куда хуже, чем интеграция с DNS-серовером).
