---
layout: post
title: Сравнение bind и unbound в целях фильтрации трафика по DNS
date: '2016-11-03 15:48:00'
---

# О чём вообще статья.

Есть такой репозиторий: <https://github.com/carbonsoft/named_fakezone_generator>

Его основная задача - блокировать часть запрещённых сайтов по доменному имени на стороне DNS-сервера провайдера. Оставим моральный аспект этого репозитория за рамками этой статьи, нас интересуют только цифры.

Учитывая то, что реестр запрещённой информации в РФ судя по всему будет только расти, необходимо знать, сколько ресурсов нужно для того, чтобы обеспечивать фильтрацию, достаточную, для того чтобы:

1. Не потерять лицензию / закрыться из-за штрафов.
2. Не потерять абонентов из-за ухудшения качества сервиса.

Общие данные: для каждого добавленного для фильтрации домена необходимо отвечать одним IPv4 адресом.

# Поддержка доменов с подчёркиванием

bind9 от таких доменов, оказавшихся в конфиге валится и не стартует, ругаясь. Одно из решений - заменять на дефис.

unbound чувствует себя прекрасно, на запросы об этих доменах отвечает.

# Потребление памяти

Формат записи: 1 число - VSZ, 2 - RSS из вывода ps aux. Наблюдения проводились за сервером, находящимся в состоянии "покоя" - к нему обращалась несколько раз тестовая машина только для того, чтобы проверить, что он вообще работает и живой.

Число доменов |   Unbound   |   Bind9
:-----------: | :---------: | :--------:
    8500      |  210M 49M   | 357M 101M
    25000     |  346M 157M  | 970M 306M
    50000     |  556M 315M  | 1299M 646M
   100000     |  979M 823M  | OOM error
   200000     | 1824M 1284M | OOM error
   400000     | 3515M 2655M | OOM error

# Что стоило ещё померять

- Деградация в скорости ответов
- Замедление рестарта

# Выводы

После 50000 доменов наступает существенная деградация в скорости рестарта у bind9.

На 100000 без дополнительного тюнинга bind в openvz начал валиться с out of memory error прямо при старте, съев около 1гб памяти (несмотря на то, что контейнеру было доступно 4гб).

Для одного пользователя, решившего опросить все добавленные домены с localhost потребление памяти ни unbound'ом ни bind'ом не менялось.

# Размышления

Вообще идея использовать для фильтрации DNS-сервера может показаться довольно странной. Однако DNSSec никаким спуфингом сбоку не побороть, разве что установкой фильтрации в разрыв (что на мой взгляд куда хуже, чем интеграция с DNS-серовером).
